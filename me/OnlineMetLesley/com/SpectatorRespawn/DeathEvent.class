package me.OnlineMetlesley.com.SpectatorRespawn;

import com.connorlinfoot.titleapi.TitleAPI;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import net.md_5.bungee.api.ChatColor;
import org.bukkit.Bukkit;
import org.bukkit.Effect;
import org.bukkit.GameMode;
import org.bukkit.Location;
import org.bukkit.Sound;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityDamageEvent;
import org.bukkit.plugin.Plugin;

public class DeathEvent implements Listener {
   public HashMap<String, Long> cooldown = new HashMap();
   public Plugin instance;
   List<String> command;
   String deathmessage;
   String AutoRespawnMessage;
   String respawnMessage;
   int Respawncooldown;
   String respawnedtitle;
   String respawnedsubtitle;
   String BroadcastMessage;

   public DeathEvent() {
      this.command = Main.instance.getConfig().getStringList("message");
      this.deathmessage = Main.instance.getConfig().getString("DeathMessage");
      this.AutoRespawnMessage = Main.instance.getConfig().getString("AutoRespawn.AutoRespawnMessage");
      this.respawnMessage = Main.instance.getConfig().getString("respawnMessage");
      this.Respawncooldown = Main.instance.getConfig().getInt("AutoRespawn.time");
      this.respawnedtitle = Main.instance.getConfig().getString("respawnedtitle");
      this.respawnedsubtitle = Main.instance.getConfig().getString("respawnedsubtitle");
      this.BroadcastMessage = Main.instance.getConfig().getString("BroadcastMessage");
   }

   public void function() {
      Main plugin = (Main)Main.instance;
      plugin.getServer();
   }

   @EventHandler
   public void damage(EntityDamageEvent event) {
      if (event.getEntity() instanceof Player) {
         final Player player = (Player)event.getEntity();
         final Location Loc = event.getEntity().getLocation();
         this.BroadcastMessage.replace("%player%", player.getName());
         if (!Main.instance.getConfig().getBoolean("autorespawn")) {
            if (player.getHealth() - event.getFinalDamage() <= 0.0D && event.getEntity() instanceof Player) {
               event.setCancelled(true);
               player.setGameMode(GameMode.SPECTATOR);
               player.sendMessage(ChatColor.translateAlternateColorCodes('&', this.deathmessage.replace("%player%", player.getName())));
               player.spigot().playEffect(player.getLocation(), Effect.HEART, 0, 0, 0.0F, 0.0F, 0.0F, 0.0F, 5, 30);
            }

            if (Main.instance.getConfig().getBoolean("Broadcast")) {
               Bukkit.broadcastMessage(ChatColor.translateAlternateColorCodes('&', Main.instance.getConfig().getString("BroadcastMessage")));
            }
         }

         if (Main.instance.getConfig().getBoolean("autorespawn") && player.getHealth() - event.getFinalDamage() <= 0.0D && event.getEntity() instanceof Player) {
            if (Main.instance.getConfig().getBoolean("HeartEffect")) {
               player.spigot().playEffect(player.getLocation(), Effect.HEART, 0, 0, 0.0F, 0.0F, 0.0F, 0.0F, 5, 30);
            }

            this.cooldown.put(player.getName(), System.currentTimeMillis());
            player.setGameMode(GameMode.SPECTATOR);
            player.sendMessage(ChatColor.translateAlternateColorCodes('&', this.AutoRespawnMessage.replace("%player%", player.getName())));
            event.setCancelled(true);
            if (Main.instance.getConfig().getBoolean("Broadcast")) {
               Bukkit.broadcastMessage(ChatColor.translateAlternateColorCodes('&', Main.instance.getConfig().getString("BroadcastMessage")));
            }

            Bukkit.getServer().getScheduler().scheduleSyncDelayedTask(Main.instance, new Runnable() {
               public void run() {
                  if (Main.instance.getConfig().getBoolean("deathcommand")) {
                     player.setGameMode(GameMode.SURVIVAL);
                     player.setHealth(20.0D);
                  } else {
                     player.setGameMode(GameMode.SURVIVAL);
                     player.setHealth(20.0D);
                     player.teleport(Loc);
                  }

                  TitleAPI.sendTitle(player, 20, 40, 20, DeathEvent.this.respawnedtitle, DeathEvent.this.respawnedsubtitle);
               }
            }, (long)(this.Respawncooldown * 20));
         }

         if (Main.instance.getConfig().getBoolean("playsound")) {
            player.playSound(player.getLocation(), Sound.valueOf(Main.instance.getConfig().getString("sound").toUpperCase()), 10.0F, 100.0F);
         }

         if (Main.instance.getConfig().getBoolean("deathcommand") && player.getHealth() - event.getFinalDamage() <= 0.0D && event.getEntity() instanceof Player) {
            Iterator var5 = Main.instance.getConfig().getStringList("deathcommands").iterator();

            while(var5.hasNext()) {
               String cmd = (String)var5.next();
               Main.instance.getServer().dispatchCommand(Bukkit.getConsoleSender(), cmd.replace("%player%", player.getName()));
            }
         }
      }

   }
}
